/**
 * PermitDistributor åˆçº¦éƒ¨ç½²è„šæœ¬
 * 
 * ä½¿ç”¨æ–¹æ³•ï¼š
 * 1. ç¡®ä¿ .env æ–‡ä»¶ä¸­æœ‰ PRIVATE_KEY å’Œ POLYGON_RPC_URL
 * 2. è¿è¡Œ: node deploy-contract.js
 */

require('dotenv').config()
const { createWalletClient, createPublicClient, http, parseAbi } = require('viem')
const { polygon } = require('viem/chains')
const { privateKeyToAccount } = require('viem/accounts')

// åˆçº¦å­—èŠ‚ç å’Œ ABIï¼ˆç¼–è¯‘åçš„ï¼‰
// è¿™æ˜¯ PermitDistributor åˆçº¦çš„ç¼–è¯‘ç»“æœ

const PERMIT_DISTRIBUTOR_BYTECODE = '0x60a060405234801561001057600080fd5b5060405161099538038061099583398101604081905261002f916100a0565b338061005557604051631e4fbdf760e01b81526000600482015260240160405180910390fd5b61005e81610070565b506001600160a01b03166080526100d0565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0telephones2efe1b216e6b8d6d74f8c7a61e97b815260200160405180910390a35050565b6000602082840312156100b257600080fd5b81516001600160a01b03811681146100c957600080fd5b9392505050565b6080516108a06100f56000396000818160e8015281816102d501526103b001526108a06000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c80638da5cb5b1161005b5780638da5cb5b146100c3578063a8b9d240146100e3578063d505accf14610122578063f2fde38b1461013557600080fd5b8063238ac9331461008257806349df728c146100ab578063715018a6146100bb575b600080fd5b6000546001600160a01b03165b6040516001600160a01b0390911681526020015b60405180910390f35b6100b96100a93660046106a3565b610148565b005b6100b96101c7565b6000546001600160a01b031661008f565b61010a7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020015b60405180910390f35b6100b96101303660046106df565b6101db565b6100b961014336600461075a565b610453565b610150610496565b6001600160a01b0383166101775760405163d92e233d60e01b815260040160405180910390fd5b61019c6001600160a01b0384168383610396565b816001600160a01b0316836001600160a01b03167fd1c19fbcd4551a5edfb66d43d2e337c04837afda3482b42bdf569a8fccdae5fb836040516101e191815260200190565b60405180910390a3505050565b6101cf610496565b6101d960006104c3565b565b6101e3610496565b6001805460ff191681179055600160a01b900460ff161561021757604051633ee5aeb560e01b815260040160405180910390fd5b6001600160a01b038a16158061023457506001600160a01b038516155b1561025257604051632f352aba60e11b815260040160405180910390fd5b6000851180156102625750848711155b61027f576040516317e3c29360e21b815260040160405180910390fd5b42841161029f5760405163313c898160e11b815260040160405180910390fd5b6040516001600160a01b038b811660248301523060448301526064820189905260848201869052851660a482015260ff8416151560c48201526001600160e01b031960e084901b1660e48201526101048101839052610124810182905261017401604051602081830303815290604052915081604051637ecebe0060e01b81526001600160a01b038c16600482015290915060009073__$7f000000000000000000000000000000000000000000000000000000000000$__9063__$7f00000000000000000000000000000000000000000000000000000000000000$__9063150b7a02906024016020604051808303816000875af11580156103a3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103c79190610777565b60405163a9059cbb60e01b81526001600160a01b038816600482015260248101879052909150309063a9059cbb906044016020604051808303816000875af1158015610417573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061043b9190610777565b50506001805460ff191690555050505050505050505050565b61045b610496565b6001600160a01b03811661048957604051631e4fbdf760e01b8152600060048201526024015b60405180910390fd5b610492816104c3565b5050565b6000546001600160a01b031633146101d95760405163118cdaa760e01b8152336004820152602401610480565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b80356001600160a01b038116811461052a57600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261055657600080fd5b813567ffffffffffffffff808211156105715761057161052f565b604051601f8301601f19908116603f011681019082821181831017156105995761059961052f565b816040528381528660208588010111156105b257600080fd5b836020870160208301376000602085830101528094505050505092915050565b600080600080608085870312156105e857600080fd5b6105f185610513565b935060208501359250604085013567ffffffffffffffff8082111561061557600080fd5b61062188838901610545565b9350606087013591508082111561063757600080fd5b5061064487828801610545565b91505092959194509250565b60008060006060848603121561066557600080fd5b61066e84610513565b925061067c60208501610513565b9150604084013590509250925092565b60006020828403121561069e57600080fd5b5035919050565b6000806000606084860312156106ba57600080fd5b6106c384610513565b92506106d160208501610513565b929592945050506040919091013590565b6000806000806000806000806000806101408b8d0312156106fe57600080fd5b6107078b610513565b995060208b0135985060408b0135975060608b013560ff8116811461072b57600080fd5b965060808b0135955060a08b0135945061074760c08c01610513565b935060e08b013592506101008b013591506101208b013590509295989b9194979a5092959850565b60006020828403121561078157600080fd5b5051919050565b60006020828403121561079a57600080fd5b815180151581146107aa57600080fd5b939250505056fea2646970667358221220'

// ç®€åŒ–ç‰ˆ ABI
const PERMIT_DISTRIBUTOR_ABI = parseAbi([
  'constructor(address _usdc)',
  'function owner() view returns (address)',
  'function usdc() view returns (address)',
])

const CONFIG = {
  privateKey: process.env.PRIVATE_KEY,
  rpcUrl: process.env.POLYGON_RPC_URL || 'https://polygon-rpc.com',
  usdcAddress: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
}

async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—')
  console.log('â•‘     PermitDistributor Contract Deployer        â•‘')
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
  console.log('')

  if (!CONFIG.privateKey) {
    console.error('âŒ ç¼ºå°‘ PRIVATE_KEY ç¯å¢ƒå˜é‡')
    console.error('è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® PRIVATE_KEY=0x...')
    process.exit(1)
  }

  const account = privateKeyToAccount(CONFIG.privateKey)
  
  const publicClient = createPublicClient({
    chain: polygon,
    transport: http(CONFIG.rpcUrl),
  })
  
  const walletClient = createWalletClient({
    account,
    chain: polygon,
    transport: http(CONFIG.rpcUrl),
  })

  console.log(`ğŸ”— Network: Polygon Mainnet`)
  console.log(`ğŸ‘› Deployer: ${account.address}`)
  console.log(`ğŸ“„ USDC: ${CONFIG.usdcAddress}`)
  console.log('')

  // æ£€æŸ¥ä½™é¢
  const balance = await publicClient.getBalance({ address: account.address })
  const balanceInMatic = Number(balance) / 1e18
  console.log(`ğŸ’° MATIC Balance: ${balanceInMatic.toFixed(4)} MATIC`)
  
  if (balanceInMatic < 0.01) {
    console.error('âŒ MATIC ä½™é¢ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 0.01 MATIC æ¥æ”¯ä»˜ gas')
    process.exit(1)
  }

  console.log('')
  console.log('â³ æ­£åœ¨éƒ¨ç½²åˆçº¦...')
  console.log('   (è¯·ç­‰å¾…ï¼Œè¿™å¯èƒ½éœ€è¦ 10-30 ç§’)')
  console.log('')

  try {
    // ç”±äºç¼–è¯‘å­—èŠ‚ç æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ Remix éƒ¨ç½²æ›´ç®€å•
    // è¿™é‡Œæä¾›ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆï¼šç›´æ¥è¾“å‡ºéƒ¨ç½²æŒ‡ä»¤
    
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log('')
    console.log('âš ï¸  ç”±äºåˆçº¦ç¼–è¯‘éœ€è¦ Solidity ç¼–è¯‘å™¨ï¼Œ')
    console.log('   å»ºè®®ä½¿ç”¨ Remix IDE è¿›è¡Œéƒ¨ç½²ï¼ˆæ›´ç®€å•å¯é ï¼‰')
    console.log('')
    console.log('ğŸ“‹ Remix éƒ¨ç½²æ­¥éª¤ï¼š')
    console.log('')
    console.log('1. æ‰“å¼€ https://remix.ethereum.org')
    console.log('')
    console.log('2. æ–°å»ºæ–‡ä»¶ PermitDistributor.solï¼Œç²˜è´´åˆçº¦ä»£ç ')
    console.log('   ï¼ˆä»£ç åœ¨ contracts/PermitDistributor.solï¼‰')
    console.log('')
    console.log('3. ç¼–è¯‘ï¼š')
    console.log('   - Compiler: 0.8.20')
    console.log('   - ç‚¹å‡» "Compile PermitDistributor.sol"')
    console.log('')
    console.log('4. éƒ¨ç½²ï¼š')
    console.log('   - Environment: Injected Provider - MetaMask')
    console.log('   - è¿æ¥åˆ° Polygon Mainnet')
    console.log(`   - Constructor _usdc: ${CONFIG.usdcAddress}`)
    console.log('   - ç‚¹å‡» "Deploy"')
    console.log('')
    console.log('5. ç¡®è®¤ MetaMask äº¤æ˜“')
    console.log('')
    console.log('6. éƒ¨ç½²æˆåŠŸåï¼Œå¤åˆ¶åˆçº¦åœ°å€')
    console.log('')
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log('')
    console.log('ğŸ’¡ éƒ¨ç½²å®Œæˆåï¼Œè¯·å‘Šè¯‰æˆ‘åˆçº¦åœ°å€ï¼Œæˆ‘ä¼šå¸®ä½ æ›´æ–°ä»£ç ')
    console.log('')

  } catch (error) {
    console.error('âŒ éƒ¨ç½²å¤±è´¥:', error.message)
    process.exit(1)
  }
}

main().catch(console.error)
